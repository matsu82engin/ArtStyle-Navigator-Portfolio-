# ■ サービス名：絵柄探し

## ■ 概要
自分の好きな画風を探し、その画風に特化した画像、使用画材などの情報をユーザー同士で共有できるサービスです。


## ■ 作成背景
私は以前漫画家を目指していたのですが、目指し始めた時は絵が上手くありませんでした。<br>

もちろんうまくなるように努力はするのですが、"どういう風な絵で上手くなりたいのか" ということが、教材やどんな情報サイトにもあまり載っていなかったのを記憶しています。<br>
絵の描き方は人によって違うので、絵を描くのは上手くなったけれど自分の描く絵が自分は好きじゃない、という不思議な現象が身近でしばしば起きていたことがあります。<br>

その現象を少しでも解消し、自分が求める画風を探して、その画風の描き方や他の人が行っているコツの情報を共有したりする、<br>
絵が上手くなりたい人に向けたアプリケーションを作れたらいいのでは考え、このアプリケーションを作成したいと考えました。


## ■目的
- 絵が上手くなりたい人が、自分の好きな絵で上手くなれるような情報が見れる。
- 自分の画風の他の描き方や道具の情報を共有する。
- コツや情報を知ることで、絵を描くモチベーションが上がる


## ■ターゲット
- 自分の好きな画風を見つけ、その画風で上手くなりたい人
- 自分と同じような画風で他の人の描き方やコツを知りたい人
- 他の人がどんな画材道具を使っているか知りたい人


## ■メリット
- 自分の好きな絵で努力ができるようになる。
- その人しか知らないおすすめの描き方のコツや情報が見れる。


## ■工夫した点・こだわった点
本アプリでは認証設計において、
devise_token_auth の仕様を理解した上で、サーバー負荷軽減を目的としたトークン更新方式を工夫しました。

### 詳細：
一般的にリフレッシュトークンは、アクセストークンの有効期限がすぎてもリフレッシュトークンが有効であれば、新しいアクセストークンを取得しログイン状態を維持するために使用されると思います。

私のポートフォリオでは devise_token_auth を使っているのでリフレッシュトークンは必要ないのですが、設計当初この点に気づきませんでした。<br>
(devise_token_auth は設定(config.change_headers_on_each_request = true)でリクエストごとにアクセストークンを更新する機能があるので必要ない)<br>

そして、devise_token_auth はリフレッシュトークンの機能をサポートしていないので、<br>
そもそもリフレッシュトークンの有効期限が有効で、アクセストークンが無効になっているという時にアクセストークンを新しくすることができません。<br>
これを知った時に当初、リフレッシュトークンの機能を無くそうと考えたのですが、<br>
あまり意味がないかもしれませんが、少し通常のリフレッシュトークンとは違った使い方をすることにしました。<br>

リフレッシュトークンが有効な時に、有効なアクセストークンで新しいアクセストークンを取得してログイン状態を維持する、というものです。<br>
リフレッシュトークンの有効期限が１週間より短くなったら、リフレッシュトークンでアクセストークンの有効期限を更新します。<br>

正直あまり大きなメリットはないかもしれませんが、<br>
devise_token_auth では config.change_headers_on_each_request = true でリクエストごとにアクセストークンを更新するので、
サーバーに負荷がかかってしまいます。<br>
そこでこの機能をオフにして、リフレッシュトークンでアクセストークンの更新をすると、一定期間ごとにしかリクエストごとのトークンの更新は行われないので、サーバー負荷の軽減を目的としました。


## ■苦労した点・解決方法
当初 Nuxt をSSR にしていた時に devise_token_auth と相性が悪く SPA にする必要があったことで苦労した点

1. auth モジュールを使うとページ遷移ごとにサーバーにユーザー情報を取得しにいきます。(fetchUser)
2. authenticate_user! に引っかかります。(devise_token_auth を導入しているのでヘッダーに認証情報が必須)
3. なぜ引っかかるかというと SSR のタイミング(サーバー上)だとクッキーにアクセスできないので、クッキーの認証情報をヘッダーに載せられないからです。
4. 対処法として、まず axios のインターセプターではリロードで失敗するので無理でした。<br>
次に vuex-persistedstate で localStorage からユーザー情報を復元できるので、それでヘッダーに認証情報を載せようとしたが、<br>
SSRリロード時に auth モジュールがバックエンドにリクエストを飛ばすのでストレージの復元が間に合わないためこれも失敗でした。<br>

悩んだ末の見解：
devise_token_auth を使っていなければヘッダーに認証情報を入れなくてもいいのですが、これは変えたくないと考えました。(devise はデファクトスタンダード)<br><br>
よって、SPA ならば最初からクライアントサイドでクッキー(localStorage)にアクセスできるのでヘッダーに認証情報が載せれるので解決できました。<br>
現在は別の実装方法も考えられると理解していますが、本アプリでは学習コストと保守性を考慮しSPA構成を採用しました。<br>


## ■今後の改善点
- フォロー機能の完成
- 自分の絵柄の診断する機能の実装
- Render へデプロイ
- Docker で環境構築<br>
***CentOS7.9で作っていたのでパッケージがEOLになっています。** <br>
このままではセキュリティ的に危険なので、Docker を使う際に CentOS7からバージョンを変更予定です。


## ■機能一覧
○ログイン機能
- 新規ユーザー登録/退会(ユーザー名、メールアドレス、パスワード、パスワード確認)
- ログイン(メールアドレス、パスワード)
- ログアウト

○マイページ機能
- アカウント情報変更/アカウント削除
- フォローしているユーザー一覧表示機能(未実装)
- フォロワー一覧表示機能(未実装)
- 自分が投稿した絵の一覧表示

○投稿機能
- 絵とテキストの投稿機能(編集、削除)

○検索機能
- さまざまな画風のユーザーを検索する機能(未実装)

○画風診断機能
- 自分の絵柄を診断する機能(未実装)


## ■ 使用技術一覧

◇フロントエンド
- HTML/CSS
- JavaScript
- Nuxt.js(2.15.8)(SPAモード)
- Vuetify (UIフレームワーク)
- ESLint/Prettier(コード解析ツール)

◇バックエンド
- Ruby(3.1.3)
- Ruby on Rails(6.1.4)
- MySQL(8.0.31)
- Rubocop (コード解析ツール)
- Rspec (テスト)

◇バージョン管理
- Git/GitHub

◇開発環境
- Visual Studio Code
- Docker(予定)
